// Code generated by openapi-generator; DO NOT EDIT.
{{>partial_header}}
package {{packageName}}

import (
	"net/http"
	"strings"
	"fmt"
	"github.com/gin-gonic/gin"
)

// Route is the information for every URI.
type Route struct {
	// Name is the name of this Route.
	Name        string
	// Method is the string for the HTTP method. ex) GET, POST etc..
	Method      string
	// Pattern is the pattern of the URI.
	Pattern     string
	// HandlerFunc is the handler function of this route.
	HandlerFunc gin.HandlerFunc
}

// Routes is the list of the generated Route.
type Routes []Route

// NewRouter returns a new router.
func NewRouter() *gin.Engine {
	router := gin.Default()

	// configure the server.
	if err := Configure(router); err != nil {
		panic(err)
	}

	for _, route := range routes {
		switch route.Method {
		case http.MethodGet:
			router.GET(route.Pattern, route.HandlerFunc)
		case http.MethodPost:
			router.POST(route.Pattern, route.HandlerFunc)
		case http.MethodPut:
			router.PUT(route.Pattern, route.HandlerFunc)
		case http.MethodDelete:
			router.DELETE(route.Pattern, route.HandlerFunc)
		}
	}

	return router
}

{{#authMethods}}
{{#isBasicBearer}}
// {{name}} authentication
// func {{name}} (c *gin.Context) (*Principal, error) {
//	bearer := c.GetHeader("Authorization")
//
//	encrypted, err := auth.NewEncryptedBearer(bearer)
//	if err != nil {
//		return nil, err
//	}
//
//	return encrypted.ValidateRemote()
//}

func bearerAuthHandler (c *gin.Context) (*Principal, error) {
	// BasicBearer
	principal, err := {{name}}(c)
	if err != nil {
		// Not authorized
		c.JSON(http.StatusUnauthorized, gin.H{
			"code": 401,
			"message": err.Error(),
		})
		return nil, err
	}
	
	return principal, err
}

{{/isBasicBearer}}

{{#isApiKey}}
// func {{name}} (c *gin.Context) (*Principal, error) {
//	apiKey, err := auth.NewApiKey(c.GetHeader("X-API-KEY"))
//	if err != nil {
//		return nil, err
//	}
//	{{^vendorExtensions.x-validate-local}}return apiKey.ValidateRemote(){{/vendorExtensions.x-validate-local}}
//	{{#vendorExtensions.x-validate-local}}return apiKey.Validate(){{/vendorExtensions.x-validate-local}}
//}
{{/isApiKey}}

{{/authMethods}}

{{#apiInfo}}{{#apis}}{{#operations}}{{#operation}}
// {{operationId}}Api API handler for {{operationId}}
type {{operationId}}Api struct {
	{{#bodyParam}}
	// Body params
	body *{{dataType}}{{/bodyParam}}
	{{#pathParams}}
	// Path params 
	{{paramName}} {{#isNullable}}*{{/isNullable}}{{dataType}} {{#description}}// {{{description}}} {{/description}}
	{{/pathParams}}
	{{#queryParams}}
	// Query params
	{{paramName}} {{#isNullable}}*{{/isNullable}}{{dataType}} {{#description}}// {{{description}}} {{/description}}
	{{/queryParams}}

	// Form params
	{{#formParams}}
    {{#isBinary}}
    {{paramName}} *multipart.FileHeader `form:"{{baseName}}"{{#required}} binding:"required"{{/required}}`
    {{/isBinary}}
    {{^isBinary}}
	{{paramName}} {{#isNullable}}*{{/isNullable}}{{dataType}} {{#description}}// {{{description}}} {{/description}}
	{{/isBinary}}
	{{/formParams}}
	{{#authMethods}}
	Principal *Principal // Principal
	{{#isBasicBearer}}
	{{/isBasicBearer}}
	{{/authMethods}}
}

// {{operationId}}Handler for {{operationId}} {{httpMethod}} {{{path}}} {{#description}}
// {{{description}}}{{/description}}
//go:generate go-codegen restapi-handler -name {{operationId}} -method {{httpMethod}} -path {{{path}}} {{#description}}-desc "{{{description}}}"{{/description}}
func {{operationId}}Handler (c *gin.Context) {
	// API context
	api := &{{operationId}}Api{}

	{{#authMethods}}{{#isBasicBearer}}
	// BasicBearer
	{
		var err error
		api.Principal, err = bearerAuthHandler(c)
		if err != nil {
			return
		}
	}
	{{/isBasicBearer}}{{#isApiKey}}
	{
		var err error
		api.Principal, err = {{name}}(c)
		if err != nil {
			c.JSON(http.StatusUnauthorized, gin.H{
				"code": 401,
				"message": err.Error(),
			})
			return
		}
	}
	{{/isApiKey}}{{/authMethods}}

	{{#pathParams}}
	// path params
	{{#isString}}{{>partial_param_string}}{{/isString}}
	{{/pathParams}}

	{{#queryParams}}
	// query params
	{{#isString}}{{>partial_param_string}}{{/isString}}
	{{#required}}

	{{/required}}
	{{^required}}

	{{/required}}
	{{/queryParams}}

	{{#formParams}}
	{{#isString}}{{>partial_param_string}}{{/isString}}
	{{#isBinary}}{{>partial_param_binary}}{{/isBinary}}
	{{/formParams}}

	{{#bodyParam}}{{#required}}
	// Body is required
	{
		api.body = &{{dataType}}{}
		if err := c.ShouldBind(api.body); err != nil {
			c.JSON(http.StatusBadRequest, gin.H{
				"code": 400,
				"message": err.Error(),
			})
			return
		}
	}
	{{^isPrimitiveType}}
	errs := api.body.Validates()
	if errs.HasError() {
		c.JSON(http.StatusBadRequest, gin.H{
			"code": 400,
			"message": errs.Error(),
		})
		return
	}
	{{/isPrimitiveType}}{{/required}}{{^required}}
	// Body is optional
	{
		api.body = &{{dataType}}{}
		if err := c.ShouldBind(api.body); err != nil {
			c.JSON(http.StatusBadRequest, gin.H{
				"code": 400,
				"message": err.Error(),
			})
			return
		}
	}
	{{^isPrimitiveType}}
	errs := api.body.Validates()
	if errs.HasError() {
		c.JSON(http.StatusBadRequest, gin.H{
			"code": 400,
			"message": errs.Error(),
		})
		return
	}
	{{/isPrimitiveType}}{{/required}}{{/bodyParam}}

	// Handle the request
	c.JSON(api.Handle(c))
}
{{/operation}}{{/operations}}{{/apis}}{{/apiInfo}}

var routes = Routes{
	{{#apiInfo}}{{#apis}}{{#operations}}{{#operation}}
	{
		"{{operationId}}",
		http.Method{{httpMethod}},
		"{{{basePathWithoutHost}}}{{{path}}}",
		{{operationId}}Handler,
	},{{/operation}}{{/operations}}{{/apis}}{{/apiInfo}}
}
